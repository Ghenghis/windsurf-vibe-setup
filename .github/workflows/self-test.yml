name: Self-Test, Audit & Repair

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run weekly self-repair on Sundays at midnight
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      repair:
        description: 'Run self-repair'
        required: false
        default: 'false'

jobs:
  audit:
    name: Code Audit & Quality Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          npm ci --prefer-offline --no-audit
          
      - name: Run self-audit
        run: |
          node self-audit.js > audit-output.txt 2>&1
          cat audit-output.txt
          
      - name: Upload audit report
        uses: actions/upload-artifact@v3
        with:
          name: audit-report
          path: |
            AUDIT_REPORT.md
            audit-output.txt
      
      - name: Check code quality score
        run: |
          SCORE=$(grep "Code Quality Score" AUDIT_REPORT.md | grep -oE "[0-9]+/100" | cut -d'/' -f1)
          echo "Code Quality Score: $SCORE"
          if [ "$SCORE" -lt "70" ]; then
            echo "‚ùå Code quality score too low: $SCORE/100"
            exit 1
          fi
          echo "‚úÖ Code quality acceptable: $SCORE/100"
  
  test-tools:
    name: Test Tool Functionality
    runs-on: ubuntu-latest
    needs: audit
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit
      
      - name: Test harness initialization
        run: |
          node -e "
          const { harness } = require('./mcp-server/src/harness');
          harness.config.enabled = true;
          console.log('Harness config:', harness.config);
          "
      
      - name: Count actual tools
        run: |
          node -e "
          const fs = require('fs');
          const content = fs.readFileSync('./mcp-server/src/index.js', 'utf8');
          const handlers = content.match(/async \(args\) =>/g) || [];
          console.log('Tool handlers found:', handlers.length);
          "
      
      - name: Verify v4.x features
        run: |
          echo "Checking v4.x features..."
          [ -f "mcp-server/src/multi-agent-tools.js" ] && echo "‚úÖ Multi-agent tools found" || echo "‚ùå Multi-agent tools missing"
          [ -f "mcp-server/src/hive-mind.js" ] && echo "‚úÖ Hive Mind found" || echo "‚ùå Hive Mind missing"
          [ -f "mcp-server/src/open-interpreter-tools.js" ] && echo "‚úÖ Open Interpreter found" || echo "‚ùå Open Interpreter missing"
          [ -d "mcp-server/src/harness" ] && echo "‚úÖ Harness found" || echo "‚ùå Harness missing"
  
  documentation:
    name: Documentation Validation
    runs-on: ubuntu-latest
    needs: audit
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Check README files
        run: |
          echo "Checking documentation files..."
          FILES=(
            "README.md"
            "README_VIBE_CODERS.md"
            "COMPLETE_SYSTEM_GUIDE.md"
            "HARNESS_INTEGRATION_COMPLETE.md"
            "SETUP_CLAUDE_SUBSCRIPTION.md"
          )
          
          for file in "${FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "‚úÖ $file exists"
              # Check file size
              SIZE=$(stat -c%s "$file")
              if [ "$SIZE" -lt "1000" ]; then
                echo "‚ö†Ô∏è $file seems too small ($SIZE bytes)"
              fi
            else
              echo "‚ùå $file missing"
              exit 1
            fi
          done
      
      - name: Validate Markdown
        uses: DavidAnson/markdownlint-cli2-action@v13
        continue-on-error: true
        with:
          globs: '**/*.md'
  
  self-repair:
    name: Self-Repair System
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event.inputs.repair == 'true'
    needs: [audit, test-tools, documentation]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit
      
      - name: Run self-repair
        run: |
          echo "üîß Running self-repair..."
          node self-audit.js --fix
          
      - name: Check for changes
        id: git-check
        run: |
          git diff --exit-code || echo "changes=true" >> $GITHUB_OUTPUT
      
      - name: Create Pull Request
        if: steps.git-check.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "üîß Self-repair: Auto-fixes and enhancements"
          title: "üîß Self-Repair: Automated fixes and improvements"
          body: |
            ## ü§ñ Automated Self-Repair
            
            This PR contains automated fixes identified by the self-repair system:
            
            - Fixed missing files
            - Updated stubs
            - Corrected documentation
            - Performance optimizations
            
            Please review the changes before merging.
            
            ---
            *Generated by Self-Repair System*
          branch: self-repair/auto-fix
          delete-branch: true
  
  performance:
    name: Performance Check
    runs-on: ubuntu-latest
    needs: audit
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit
      
      - name: Measure load time
        run: |
          node -e "
          const start = Date.now();
          require('./mcp-server/src/index.js');
          const loadTime = Date.now() - start;
          console.log('Load time:', loadTime, 'ms');
          if (loadTime > 5000) {
            console.error('‚ùå Load time too high!');
            process.exit(1);
          }
          "
      
      - name: Check memory usage
        run: |
          node -e "
          require('./mcp-server/src/index.js');
          const usage = process.memoryUsage();
          console.log('Memory usage:');
          console.log('  RSS:', Math.round(usage.rss / 1024 / 1024), 'MB');
          console.log('  Heap Used:', Math.round(usage.heapUsed / 1024 / 1024), 'MB');
          if (usage.heapUsed > 500 * 1024 * 1024) {
            console.error('‚ùå Memory usage too high!');
            process.exit(1);
          }
          "
